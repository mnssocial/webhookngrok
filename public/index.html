<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook Management - Developer Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }
        .webhook-card {
            transition: all 0.2s;
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
        }
        .webhook-card:hover {
            border-color: #569cd6;
            box-shadow: 0 0 20px rgba(86, 156, 214, 0.3);
        }
        .stat-card {
            background: #252526;
            border: 1px solid #3c3c3c;
        }
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }
        .code-font {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }
        .method-badge {
            font-family: monospace;
            font-weight: bold;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 3px;
        }
        .url-box {
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            font-family: 'Consolas', monospace;
        }
        .btn-primary {
            background: #0e639c;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background: #1177bb;
        }
        .sidebar {
            background: #252526;
            border-right: 1px solid #3c3c3c;
        }
    </style>
</head>
<body class="bg-[#1e1e1e] text-gray-200 min-h-screen">
    <!-- Top Bar (VS Code style) -->
    <header class="bg-[#323233] border-b border-[#3c3c3c] px-4 py-2">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-code text-[#569cd6] text-xl"></i>
                    <span class="text-lg font-semibold text-gray-200">Webhook Manager</span>
                </div>
                <div class="hidden md:flex items-center space-x-6 text-sm text-gray-400">
                    <span class="flex items-center space-x-1">
                        <i class="fas fa-circle text-green-500 text-xs"></i>
                        <span>Server Running</span>
                    </span>
                </div>
            </div>
            <button onclick="openCreateModal()" class="bg-[#0e639c] hover:bg-[#1177bb] text-white px-4 py-1.5 rounded text-sm font-medium transition">
                <i class="fas fa-plus mr-2"></i>New Webhook
            </button>
        </div>
    </header>

    <div class="flex h-[calc(100vh-42px)]">
        <!-- Sidebar (File Explorer style) -->
        <aside class="sidebar w-64 overflow-y-auto">
            <div class="p-4">
                <div class="mb-6">
                    <div class="text-xs font-semibold text-gray-500 uppercase mb-3 flex items-center">
                        <i class="fas fa-chart-bar mr-2"></i>Statistics
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center justify-between p-2 bg-[#1e1e1e] rounded">
                            <span class="text-gray-400">Webhooks</span>
                            <span class="text-[#4ec9b0] font-bold" id="totalWebhooks">0</span>
                        </div>
                        <div class="flex items-center justify-between p-2 bg-[#1e1e1e] rounded">
                            <span class="text-gray-400">Events</span>
                            <span class="text-[#dcdcaa] font-bold" id="totalEvents">0</span>
                        </div>
                        <div class="flex items-center justify-between p-2 bg-[#1e1e1e] rounded">
                            <span class="text-gray-400">Active</span>
                            <span class="text-green-500 font-bold" id="activeWebhooks">0</span>
                        </div>
                        <div class="flex items-center justify-between p-2 bg-[#1e1e1e] rounded">
                            <span class="text-gray-400">Inactive</span>
                            <span class="text-gray-500 font-bold" id="inactiveWebhooks">0</span>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="text-xs font-semibold text-gray-500 uppercase mb-3 flex items-center">
                        <i class="fas fa-server mr-2"></i>Server Info
                    </div>
                    <div class="space-y-2 text-xs">
                        <div class="text-gray-400">
                            <span class="text-gray-500">Port:</span>
                            <span class="text-[#569cd6] ml-2">3000</span>
                        </div>
                        <div class="text-gray-400">
                            <span class="text-gray-500">Status:</span>
                            <span class="text-green-500 ml-2">● Online</span>
                        </div>
                        <div class="text-gray-400">
                            <span class="text-gray-500">Ngrok:</span>
                            <span class="ml-2" id="ngrokStatus">
                                <span class="text-gray-600">● Offline</span>
                            </span>
                        </div>
                        <button onclick="openNgrokModal()" class="w-full mt-3 bg-[#0e639c] hover:bg-[#1177bb] text-white px-3 py-2 rounded text-xs transition code-font">
                            <i class="fas fa-rocket mr-1"></i>Ativar Ngrok
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-[#1e1e1e] p-6">
            <!-- Header -->
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-gray-200 mb-2 code-font">
                    <span class="text-[#569cd6]">class</span> <span class="text-[#4ec9b0]">WebhookManager</span>
                </h1>
                <p class="text-sm text-gray-500 code-font">// Manage and monitor your webhook endpoints</p>
            </div>

            <!-- Webhooks Grid -->
            <div id="webhooksList" class="space-y-4">
                <!-- Webhooks will be loaded here -->
            </div>
        </main>
    </div>

    <!-- Modal - Create/Edit Webhook -->
    <div id="webhookModal" class="hidden fixed inset-0 bg-black/70 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-[#252526] border border-[#3c3c3c] rounded-lg shadow-2xl max-w-lg w-full">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-4 border-b border-[#3c3c3c]">
                <h3 class="text-lg font-semibold text-gray-200 code-font" id="modalTitle">
                    <span class="text-[#569cd6]">new</span> Webhook()
                </h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <form id="webhookForm" onsubmit="saveWebhook(event)" class="p-4">
                <input type="hidden" id="webhookId">

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-2 code-font">
                            <span class="text-[#569cd6]">const</span> name<span class="text-gray-600">:</span> <span class="text-[#4ec9b0]">string</span>
                        </label>
                        <input type="text" id="webhookName" required
                            class="w-full px-3 py-2 bg-[#1e1e1e] border border-[#3c3c3c] rounded text-gray-200 focus:border-[#569cd6] focus:outline-none code-font text-sm"
                            placeholder="payment-webhook">
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-2 code-font">
                            <span class="text-[#569cd6]">const</span> application<span class="text-gray-600">:</span> <span class="text-[#4ec9b0]">string</span>
                        </label>
                        <input type="text" id="webhookApplication"
                            class="w-full px-3 py-2 bg-[#1e1e1e] border border-[#3c3c3c] rounded text-gray-200 focus:border-[#569cd6] focus:outline-none code-font text-sm"
                            placeholder="E-commerce API">
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-2 code-font">
                            <span class="text-[#569cd6]">const</span> description<span class="text-gray-600">:</span> <span class="text-[#4ec9b0]">string</span>
                        </label>
                        <textarea id="webhookDescription" rows="3"
                            class="w-full px-3 py-2 bg-[#1e1e1e] border border-[#3c3c3c] rounded text-gray-200 focus:border-[#569cd6] focus:outline-none code-font text-sm"
                            placeholder="// Receives payment confirmation events..."></textarea>
                    </div>
                </div>

                <div class="flex space-x-3 mt-6">
                    <button type="button" onclick="closeModal()"
                        class="flex-1 px-4 py-2 bg-[#1e1e1e] border border-[#3c3c3c] rounded text-gray-300 hover:bg-[#2d2d30] transition text-sm code-font">
                        Cancel
                    </button>
                    <button type="submit"
                        class="flex-1 px-4 py-2 btn-primary text-white rounded font-medium text-sm code-font">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal - Ngrok Setup -->
    <div id="ngrokModal" class="hidden fixed inset-0 bg-black/70 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-[#252526] border border-[#3c3c3c] rounded-lg shadow-2xl max-w-md w-full">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-4 border-b border-[#3c3c3c]">
                <h3 class="text-lg font-semibold text-gray-200 code-font">
                    <i class="fas fa-rocket text-[#569cd6] mr-2"></i>
                    Ativar Ngrok Tunnel
                </h3>
                <button onclick="closeNgrokModal()" class="text-gray-500 hover:text-gray-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6">
                <div id="ngrokSetup" class="space-y-4">
                    <div class="bg-[#1e1e1e] border border-[#3c3c3c] rounded p-4 mb-4">
                        <p class="text-sm text-gray-400 code-font mb-2">
                            <span class="text-gray-600">//</span> Cole seu token do ngrok abaixo:
                        </p>
                        <p class="text-xs text-gray-500 code-font">
                            Pegue em: <a href="https://dashboard.ngrok.com/get-started/your-authtoken" target="_blank" class="text-[#569cd6] hover:underline">dashboard.ngrok.com</a>
                        </p>
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-2 code-font">
                            <span class="text-[#569cd6]">const</span> authToken<span class="text-gray-600">:</span> <span class="text-[#4ec9b0]">string</span>
                        </label>
                        <input type="text" id="ngrokToken"
                            class="w-full px-3 py-2 bg-[#1e1e1e] border border-[#3c3c3c] rounded text-gray-200 focus:border-[#569cd6] focus:outline-none code-font text-sm"
                            placeholder="2abc...XYZ">
                    </div>

                    <button onclick="activateNgrok()"
                        class="w-full px-4 py-3 bg-[#0e639c] hover:bg-[#1177bb] text-white rounded font-medium text-sm code-font transition">
                        <i class="fas fa-rocket mr-2"></i>Ativar Sistema Completo
                    </button>
                </div>

                <div id="ngrokActivating" class="hidden text-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#569cd6] mx-auto mb-4"></div>
                    <p class="text-gray-400 code-font">Ativando ngrok tunnel...</p>
                    <p class="text-gray-600 text-xs code-font mt-2">Aguarde alguns segundos</p>
                </div>

                <div id="ngrokSuccess" class="hidden text-center py-8">
                    <i class="fas fa-check-circle text-green-500 text-5xl mb-4"></i>
                    <p class="text-green-400 font-bold code-font mb-2">Sistema Ativado!</p>
                    <p class="text-gray-400 text-sm code-font mb-4">Seu webhook está público</p>
                    <div class="bg-[#1e1e1e] border border-[#3c3c3c] rounded p-3 mb-4">
                        <p class="text-xs text-gray-500 code-font mb-1">URL Pública:</p>
                        <code class="text-[#569cd6] text-sm code-font break-all" id="ngrokPublicUrl">-</code>
                    </div>
                    <button onclick="closeNgrokModal()" class="bg-[#0e639c] hover:bg-[#1177bb] text-white px-6 py-2 rounded code-font text-sm">
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let webhooks = [];
        let ngrokUrl = window.location.origin;

        async function loadData() {
            await Promise.all([loadWebhooks(), loadStats()]);
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();

                document.getElementById('totalWebhooks').textContent = stats.totalWebhooks;
                document.getElementById('totalEvents').textContent = stats.totalEvents;
                document.getElementById('activeWebhooks').textContent = stats.activeWebhooks;
                document.getElementById('inactiveWebhooks').textContent = stats.inactiveWebhooks;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadWebhooks() {
            try {
                const response = await fetch('/api/webhooks');
                const data = await response.json();
                webhooks = data.webhooks;
                renderWebhooks();
            } catch (error) {
                console.error('Error loading webhooks:', error);
            }
        }

        function renderWebhooks() {
            const container = document.getElementById('webhooksList');

            if (webhooks.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-20 text-center">
                        <i class="fas fa-folder-open text-6xl text-gray-700 mb-4"></i>
                        <p class="text-gray-500 text-lg code-font">No webhooks found</p>
                        <p class="text-gray-600 text-sm mt-2 code-font">// Click "New Webhook" to create one</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = webhooks.map(webhook => `
                <div class="webhook-card rounded-lg p-5">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <!-- Header -->
                            <div class="flex items-center space-x-3 mb-3">
                                <i class="fas fa-webhook text-[#569cd6] text-lg"></i>
                                <h3 class="text-lg font-semibold text-gray-200 code-font">${webhook.name}</h3>
                                ${webhook.active
                                    ? '<span class="px-2 py-0.5 bg-green-500/20 text-green-400 text-xs rounded code-font">active</span>'
                                    : '<span class="px-2 py-0.5 bg-gray-500/20 text-gray-500 text-xs rounded code-font">inactive</span>'
                                }
                            </div>

                            <!-- Info -->
                            <div class="space-y-2 mb-4">
                                ${webhook.application ? `
                                <div class="text-sm text-gray-400 code-font">
                                    <span class="text-gray-600">//</span> App: <span class="text-[#ce9178]">"${webhook.application}"</span>
                                </div>
                                ` : ''}
                                ${webhook.description ? `
                                <div class="text-sm text-gray-500 code-font">
                                    <span class="text-gray-600">//</span> ${webhook.description}
                                </div>
                                ` : ''}
                            </div>

                            <!-- URL Box -->
                            <div class="url-box rounded p-3 mb-3 flex items-center space-x-2">
                                <span class="text-gray-600 text-xs code-font">endpoint:</span>
                                <code class="flex-1 text-xs text-[#569cd6] code-font break-all">${ngrokUrl}${webhook.url}</code>
                                <button onclick="copyUrl('${ngrokUrl}${webhook.url}')"
                                    class="text-gray-500 hover:text-[#569cd6] transition text-sm"
                                    title="Copy URL">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>

                            <!-- Stats -->
                            <div class="flex items-center space-x-6 text-xs text-gray-500 code-font">
                                <span>
                                    <i class="fas fa-calendar-alt text-gray-600 mr-1"></i>
                                    ${formatDate(webhook.createdAt)}
                                </span>
                                <span class="flex items-center">
                                    <i class="fas fa-bell text-gray-600 mr-1"></i>
                                    <span class="text-[#dcdcaa]">${webhook.eventCount}</span> events
                                </span>
                                ${webhook.lastEvent ? `
                                <span class="text-gray-600">
                                    last: ${formatRelativeTime(webhook.lastEvent)}
                                </span>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flex flex-col space-y-2 ml-6">
                            <button onclick="viewWebhook(${webhook.id})"
                                class="px-4 py-2 bg-[#0e639c] hover:bg-[#1177bb] text-white rounded text-sm transition code-font whitespace-nowrap">
                                <i class="fas fa-eye mr-2"></i>View
                            </button>
                            <button onclick="editWebhook(${webhook.id})"
                                class="px-4 py-2 bg-[#1e1e1e] border border-[#3c3c3c] hover:border-[#569cd6] text-gray-300 rounded text-sm transition code-font">
                                <i class="fas fa-edit mr-2"></i>Edit
                            </button>
                            <button onclick="toggleWebhook(${webhook.id}, ${!webhook.active})"
                                class="px-4 py-2 ${webhook.active ? 'bg-yellow-600/20 text-yellow-500 hover:bg-yellow-600/30' : 'bg-green-600/20 text-green-500 hover:bg-green-600/30'} rounded text-sm transition code-font">
                                <i class="fas fa-${webhook.active ? 'pause' : 'play'} mr-2"></i>${webhook.active ? 'Pause' : 'Start'}
                            </button>
                            <button onclick="deleteWebhook(${webhook.id}, '${webhook.name.replace(/'/g, "\\'")}')"
                                class="px-4 py-2 bg-red-600/20 text-red-400 hover:bg-red-600/30 rounded text-sm transition code-font">
                                <i class="fas fa-trash mr-2"></i>Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openCreateModal() {
            document.getElementById('modalTitle').innerHTML = '<span class="text-[#569cd6]">new</span> Webhook()';
            document.getElementById('webhookForm').reset();
            document.getElementById('webhookId').value = '';
            document.getElementById('webhookModal').classList.remove('hidden');
        }

        function editWebhook(id) {
            const webhook = webhooks.find(w => w.id === id);
            if (!webhook) return;

            document.getElementById('modalTitle').innerHTML = '<span class="text-[#569cd6]">edit</span> Webhook()';
            document.getElementById('webhookId').value = webhook.id;
            document.getElementById('webhookName').value = webhook.name;
            document.getElementById('webhookApplication').value = webhook.application || '';
            document.getElementById('webhookDescription').value = webhook.description || '';
            document.getElementById('webhookModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('webhookModal').classList.add('hidden');
        }

        async function saveWebhook(event) {
            event.preventDefault();

            const id = document.getElementById('webhookId').value;
            const data = {
                name: document.getElementById('webhookName').value,
                application: document.getElementById('webhookApplication').value,
                description: document.getElementById('webhookDescription').value
            };

            try {
                if (id) {
                    await fetch(`/api/webhooks/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    await fetch('/api/webhooks', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                closeModal();
                await loadData();
                showToast('Webhook saved successfully');
            } catch (error) {
                console.error('Error saving webhook:', error);
                showToast('Error saving webhook', true);
            }
        }

        async function toggleWebhook(id, active) {
            try {
                await fetch(`/api/webhooks/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ active })
                });
                await loadData();
                showToast(`Webhook ${active ? 'activated' : 'paused'}`);
            } catch (error) {
                console.error('Error updating webhook:', error);
            }
        }

        async function deleteWebhook(id, name) {
            if (!confirm(`Delete webhook "${name}"? All events will be lost.`)) {
                return;
            }

            try {
                await fetch(`/api/webhooks/${id}`, { method: 'DELETE' });
                await loadData();
                showToast('Webhook deleted');
            } catch (error) {
                console.error('Error deleting webhook:', error);
            }
        }

        function viewWebhook(id) {
            window.location.href = `/webhook/${id}/view`;
        }

        function copyUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                showToast('URL copied to clipboard');
            });
        }

        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 ${isError ? 'bg-red-600' : 'bg-green-600'} text-white px-4 py-2 rounded shadow-lg z-50 code-font text-sm`;
            toast.innerHTML = `<i class="fas fa-${isError ? 'exclamation-circle' : 'check'} mr-2"></i>${message}`;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 3000);
        }

        function formatDate(isoDate) {
            return new Date(isoDate).toLocaleDateString('pt-BR');
        }

        function formatRelativeTime(isoDate) {
            const now = new Date();
            const date = new Date(isoDate);
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return `${diff}s ago`;
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return `${Math.floor(diff / 86400)}d ago`;
        }

        // ==================== NGROK FUNCTIONS ====================

        async function checkNgrokStatus() {
            try {
                const response = await fetch('/api/ngrok/status');
                const status = await response.json();

                if (status.active && status.publicUrl) {
                    ngrokUrl = status.publicUrl;
                    document.getElementById('ngrokStatus').innerHTML = '<span class="text-green-500">● Online</span>';
                    renderWebhooks(); // Re-render para atualizar URLs
                } else {
                    document.getElementById('ngrokStatus').innerHTML = '<span class="text-gray-600">● Offline</span>';
                }
            } catch (error) {
                console.error('Erro ao verificar ngrok:', error);
            }
        }

        function openNgrokModal() {
            document.getElementById('ngrokModal').classList.remove('hidden');
            document.getElementById('ngrokSetup').classList.remove('hidden');
            document.getElementById('ngrokActivating').classList.add('hidden');
            document.getElementById('ngrokSuccess').classList.add('hidden');
        }

        function closeNgrokModal() {
            document.getElementById('ngrokModal').classList.add('hidden');
        }

        async function activateNgrok() {
            const token = document.getElementById('ngrokToken').value.trim();

            if (!token) {
                showToast('Por favor, cole o token do ngrok', true);
                return;
            }

            // Hide setup, show loading
            document.getElementById('ngrokSetup').classList.add('hidden');
            document.getElementById('ngrokActivating').classList.remove('hidden');

            try {
                const response = await fetch('/api/ngrok/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ authToken: token })
                });

                const result = await response.json();

                if (result.success) {
                    // Wait a bit for ngrok to start
                    setTimeout(async () => {
                        // Get the public URL
                        const statusResponse = await fetch('/api/ngrok/status');
                        const status = await statusResponse.json();

                        if (status.publicUrl) {
                            ngrokUrl = status.publicUrl;
                            document.getElementById('ngrokPublicUrl').textContent = status.publicUrl;

                            // Hide loading, show success
                            document.getElementById('ngrokActivating').classList.add('hidden');
                            document.getElementById('ngrokSuccess').classList.remove('hidden');

                            // Update sidebar
                            document.getElementById('ngrokStatus').innerHTML = '<span class="text-green-500">● Online</span>';

                            // Reload webhooks with new URL
                            renderWebhooks();
                        }
                    }, 4000);
                } else {
                    showToast('Erro ao ativar ngrok', true);
                    closeNgrokModal();
                }
            } catch (error) {
                console.error('Erro ao ativar ngrok:', error);
                showToast('Erro ao ativar ngrok', true);
                closeNgrokModal();
            }
        }

        // Initialize
        loadData();
        checkNgrokStatus();
        setInterval(loadStats, 5000);
        setInterval(checkNgrokStatus, 10000); // Check ngrok every 10s
    </script>
</body>
</html>
