<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 min-h-screen">
    <!-- Header -->
    <header class="bg-white/10 backdrop-blur-md border-b border-white/20">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-webhook text-3xl text-white"></i>
                    <h1 class="text-2xl font-bold text-white">Webhook Manager</h1>
                </div>
                <button onclick="openCreateModal()" class="bg-white text-purple-600 px-6 py-2 rounded-lg font-semibold hover:bg-purple-50 transition flex items-center space-x-2">
                    <i class="fas fa-plus"></i>
                    <span>Novo Webhook</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Stats Cards -->
    <div class="container mx-auto px-6 py-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Total Webhooks</p>
                        <p class="text-3xl font-bold text-gray-800" id="totalWebhooks">0</p>
                    </div>
                    <div class="bg-blue-100 rounded-full p-3">
                        <i class="fas fa-link text-2xl text-blue-600"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Total Eventos</p>
                        <p class="text-3xl font-bold text-gray-800" id="totalEvents">0</p>
                    </div>
                    <div class="bg-green-100 rounded-full p-3">
                        <i class="fas fa-bell text-2xl text-green-600"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Ativos</p>
                        <p class="text-3xl font-bold text-gray-800" id="activeWebhooks">0</p>
                    </div>
                    <div class="bg-green-100 rounded-full p-3">
                        <i class="fas fa-check-circle text-2xl text-green-600"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Inativos</p>
                        <p class="text-3xl font-bold text-gray-800" id="inactiveWebhooks">0</p>
                    </div>
                    <div class="bg-gray-100 rounded-full p-3">
                        <i class="fas fa-pause-circle text-2xl text-gray-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Webhooks List -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Seus Webhooks</h2>
            <div id="webhooksList" class="space-y-4">
                <!-- Webhooks serão inseridos aqui -->
            </div>
        </div>
    </div>

    <!-- Modal - Criar/Editar Webhook -->
    <div id="webhookModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 transform transition-all">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-gray-800" id="modalTitle">Novo Webhook</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form id="webhookForm" onsubmit="saveWebhook(event)">
                <input type="hidden" id="webhookId">

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome *</label>
                        <input type="text" id="webhookName" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Ex: API Pagamentos">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Aplicação</label>
                        <input type="text" id="webhookApplication"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Ex: App Mobile">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descrição</label>
                        <textarea id="webhookDescription" rows="3"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Descreva o propósito deste webhook..."></textarea>
                    </div>
                </div>

                <div class="flex space-x-3 mt-6">
                    <button type="button" onclick="closeModal()"
                        class="flex-1 px-6 py-3 border border-gray-300 rounded-lg font-semibold text-gray-700 hover:bg-gray-50 transition">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition">
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let webhooks = [];
        let ngrokUrl = window.location.origin; // Será atualizado se ngrok estiver ativo

        // Carregar dados iniciais
        async function loadData() {
            await Promise.all([loadWebhooks(), loadStats()]);
        }

        // Carregar estatísticas
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();

                document.getElementById('totalWebhooks').textContent = stats.totalWebhooks;
                document.getElementById('totalEvents').textContent = stats.totalEvents;
                document.getElementById('activeWebhooks').textContent = stats.activeWebhooks;
                document.getElementById('inactiveWebhooks').textContent = stats.inactiveWebhooks;
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        // Carregar webhooks
        async function loadWebhooks() {
            try {
                const response = await fetch('/api/webhooks');
                const data = await response.json();
                webhooks = data.webhooks;
                renderWebhooks();
            } catch (error) {
                console.error('Erro ao carregar webhooks:', error);
            }
        }

        // Renderizar lista de webhooks
        function renderWebhooks() {
            const container = document.getElementById('webhooksList');

            if (webhooks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">Nenhum webhook cadastrado</p>
                        <p class="text-gray-400 text-sm mt-2">Clique em "Novo Webhook" para começar</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = webhooks.map(webhook => `
                <div class="border border-gray-200 rounded-xl p-6 hover:shadow-lg transition group">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <h3 class="text-xl font-bold text-gray-800">${webhook.name}</h3>
                                ${webhook.active
                                    ? '<span class="px-3 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded-full">Ativo</span>'
                                    : '<span class="px-3 py-1 bg-gray-100 text-gray-700 text-xs font-semibold rounded-full">Inativo</span>'
                                }
                            </div>

                            ${webhook.application ? `<p class="text-sm text-gray-600 mb-2"><i class="fas fa-mobile-alt mr-2"></i>${webhook.application}</p>` : ''}
                            ${webhook.description ? `<p class="text-sm text-gray-500 mb-3">${webhook.description}</p>` : ''}

                            <div class="flex items-center space-x-2 bg-gray-50 rounded-lg p-3 mb-3">
                                <code class="text-sm text-purple-600 flex-1 font-mono">${ngrokUrl}${webhook.url}</code>
                                <button onclick="copyUrl('${ngrokUrl}${webhook.url}')" class="text-gray-400 hover:text-purple-600">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>

                            <div class="flex items-center space-x-6 text-sm text-gray-500">
                                <span><i class="fas fa-calendar mr-2"></i>${formatDate(webhook.createdAt)}</span>
                                <span><i class="fas fa-bell mr-2"></i>${webhook.eventCount} eventos</span>
                                ${webhook.lastEvent ? `<span><i class="fas fa-clock mr-2"></i>${formatRelativeTime(webhook.lastEvent)}</span>` : ''}
                            </div>
                        </div>

                        <div class="flex flex-col space-y-2 ml-4">
                            <button onclick="viewWebhook(${webhook.id})"
                                class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition flex items-center space-x-2">
                                <i class="fas fa-eye"></i>
                                <span>Ver Eventos</span>
                            </button>
                            <button onclick="editWebhook(${webhook.id})"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center space-x-2">
                                <i class="fas fa-edit"></i>
                                <span>Editar</span>
                            </button>
                            <button onclick="toggleWebhook(${webhook.id}, ${!webhook.active})"
                                class="px-4 py-2 ${webhook.active ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-green-600 hover:bg-green-700'} text-white rounded-lg transition flex items-center space-x-2">
                                <i class="fas fa-${webhook.active ? 'pause' : 'play'}"></i>
                                <span>${webhook.active ? 'Pausar' : 'Ativar'}</span>
                            </button>
                            <button onclick="deleteWebhook(${webhook.id}, '${webhook.name}')"
                                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition flex items-center space-x-2">
                                <i class="fas fa-trash"></i>
                                <span>Deletar</span>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Abrir modal de criação
        function openCreateModal() {
            document.getElementById('modalTitle').textContent = 'Novo Webhook';
            document.getElementById('webhookForm').reset();
            document.getElementById('webhookId').value = '';
            document.getElementById('webhookModal').classList.remove('hidden');
        }

        // Editar webhook
        function editWebhook(id) {
            const webhook = webhooks.find(w => w.id === id);
            if (!webhook) return;

            document.getElementById('modalTitle').textContent = 'Editar Webhook';
            document.getElementById('webhookId').value = webhook.id;
            document.getElementById('webhookName').value = webhook.name;
            document.getElementById('webhookApplication').value = webhook.application || '';
            document.getElementById('webhookDescription').value = webhook.description || '';
            document.getElementById('webhookModal').classList.remove('hidden');
        }

        // Fechar modal
        function closeModal() {
            document.getElementById('webhookModal').classList.add('hidden');
        }

        // Salvar webhook
        async function saveWebhook(event) {
            event.preventDefault();

            const id = document.getElementById('webhookId').value;
            const data = {
                name: document.getElementById('webhookName').value,
                application: document.getElementById('webhookApplication').value,
                description: document.getElementById('webhookDescription').value
            };

            try {
                if (id) {
                    // Atualizar
                    await fetch(`/api/webhooks/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    // Criar
                    await fetch('/api/webhooks', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                closeModal();
                await loadData();
            } catch (error) {
                console.error('Erro ao salvar webhook:', error);
                alert('Erro ao salvar webhook');
            }
        }

        // Toggle ativo/inativo
        async function toggleWebhook(id, active) {
            try {
                await fetch(`/api/webhooks/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ active })
                });
                await loadData();
            } catch (error) {
                console.error('Erro ao atualizar webhook:', error);
            }
        }

        // Deletar webhook
        async function deleteWebhook(id, name) {
            if (!confirm(`Tem certeza que deseja deletar o webhook "${name}"? Todos os eventos serão perdidos.`)) {
                return;
            }

            try {
                await fetch(`/api/webhooks/${id}`, { method: 'DELETE' });
                await loadData();
            } catch (error) {
                console.error('Erro ao deletar webhook:', error);
            }
        }

        // Ver detalhes do webhook
        function viewWebhook(id) {
            window.location.href = `/webhook/${id}/view`;
        }

        // Copiar URL
        function copyUrl(url) {
            navigator.clipboard.writeText(url);
            // TODO: Mostrar toast de sucesso
            alert('URL copiada!');
        }

        // Formatar data
        function formatDate(isoDate) {
            return new Date(isoDate).toLocaleDateString('pt-BR');
        }

        // Formatar tempo relativo
        function formatRelativeTime(isoDate) {
            const now = new Date();
            const date = new Date(isoDate);
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return `${diff}s atrás`;
            if (diff < 3600) return `${Math.floor(diff / 60)}min atrás`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h atrás`;
            return `${Math.floor(diff / 86400)}d atrás`;
        }

        // Inicializar
        loadData();
        setInterval(loadStats, 5000); // Atualizar stats a cada 5 segundos
    </script>
</body>
</html>
